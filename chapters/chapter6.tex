% Errors

\chapter{Verification}
\label{cha:verification}

In this chapter we present the reasoning behind the verification of the core components of our register assignment pipeline, namely, the verification of the termination and the partial correctness of \texttt{eliminate}, which is the function for obtaining the \gls{peo}, defined in \Cref{subsec:peo}. Here, we report the same theorems and the respective mechanized proofs that can be found in the project, inside \texttt{core/Peo.v}.

\section{Termination of \texttt{eliminate}}

As mentioned in \Cref{subsec:funterm}, to allow a function definition, Rocq requires a proof of its termination, for functions that use structural recursion the proof of termination is inferred automatically. Instead, for other functions, an explicit proof of termination is required. This is the case for \texttt{eliminate}.

Take the \texttt{eliminate} function defined in \Cref{subsec:peo}, we recursively check the result of \texttt{eliminate\_step}. If the result is \texttt{Some} we continue with the recursion, otherwise, we return an empty list. Proving termination for this function consists of proving that, after an iteration, the size of the new graph is strictly lower than the size of the original graph. Because the size is a natural number, at some point it will reach a base case, that is, the \texttt{O} constructor.

\begin{theorem}[Termination of \texttt{eliminate}]\label{thm:term-elim}
    Let graph $G = (V, E)$, after performing one elimination step, we obtain $G' = (V', E')$ such that $V' \subsetneq V$. \Coqed
\end{theorem}
\begin{proof}
    After one iteration of the algorithm we encounter two possible cases. We either find no simplicial node, or we find a simplicial node that we name $u$, along with the graph $G - u$ that we name $G'$. In the first case, the execution terminates immediately. In the second case, however, $V' = V \setminus \{ u \}$. Because $u \in V$, we know that $V' \subsetneq V$.
\end{proof}

\section{First Invariant of \texttt{eliminate\_step}}

We start by providing a constructive definition of the $\simplicialsymbol$ relation. After that, we introduce the soundness lemma for the \texttt{is\_simplicialb} function, defined in \Cref{subsec:peo}, with respect to $\simplicialsymbol$.

Before defining the predicate, let us introduce some notation.

\begin{definition}[Node Addition]
    Let $G = (V, E)$ and $u$ be a node, we define the addition of the node $u$ as:
    \[
        G + u := (V \cup \{ u \}, E)
    \]
\end{definition}

\begin{definition}[Node Removal]
    Let $G = (V, E)$ and $u$ be a node, we define the removal of the node $u$ as:
    \[
        G - u := (V \setminus \{ u \}, \{ \{ x, y \} \mid x \neq u \land y \neq u \})
    \]
\end{definition}

\begin{definition}[Edge Addition]
    Let $G = (V, E)$ and $\{ u, v \}$ be an edge, we define the addition of the edge $\{ u, v \}$ as:
    \[
        G + \{ u, v \} := (V \cup \{ u, v \}, E \cup \{ \{ u, v \} \})
    \]
\end{definition}

\begin{definition}[Universal Vertex Over a Subgraph]
    Let $G = (V, E)$ and $H$ be a subgraph of $G$ with vertex set $V(H)$, we define the graph with a universal vertex $u$ over $H$ as:
    \[
        \addvertex{G}{H}{u} := (\{ V \cup \{ u \}, E \cup \{ \{ u, v \} \;|\; v \in V(H) \} \})
    \]
\end{definition}

\begin{definition}[Simplicial]
Let $G = (V, E)$, and $u$ be any node, we say that $u$ is simplicial in graph $G$, that is $\simplicial{u}{G}$, if one of the following rules are satisfied:
\begin{mathpar}
    \inferrule*[Right=SimplicialSingleton]
        {u \not \in V}
        % {\mathrm{Simplicial}(u, G + u)}
        {\simplicial{u}{G}}
    \\
    \inferrule*[Right=SimplicialNode]
        % {\mathrm{Simplicial}(u, G) \\ u \neq v}
        % {\mathrm{Simplicial}(u, G + v )}
        {\simplicial{u}{G} \\ u \neq v}
        {\simplicial{u}{G + v}}
    \\
    \inferrule*[Right=SimplicialEdge]
        % {\mathrm{Simplicial}(u, G) \\ u \neq v' \\ u \neq v''}
        % {\mathrm{Simplicial}(u, G + \{ v', v'' \} )}
        {\simplicial{u}{G} \\ u \neq v' \\ u \neq v''}
        {\simplicial{u}{G + \{ v', v''\}}}
    \\
    \inferrule*[Right=SimplicialNeighbor]
        {\simplicial{u}{G}}
        {\simplicial{u}{\addvertex{G}{N(u)}{u}}}
\end{mathpar}
\end{definition}

\begin{lemma}[Soundness of \texttt{is\_simplicialb}]\label{lem:sbsound}
    Let $G = (V, E)$ and $u \in V$ such that \texttt{is\_simplicialb} returns \texttt{true}, then $\simplicial{u}{G}$. \Coqed
\end{lemma}

\begin{lemma}[First Invariant of \texttt{eliminate\_step}]\label{lem:inv-elim-1}
    Let $G = (V, E)$, if \texttt{eliminate\_step} returns node $u$, then $\simplicial{u}{G}$. \Coqed
\end{lemma}
\begin{proof}
    Assume that \texttt{eliminate\_next} returns node $u$. This means that the boolean property \texttt{is\_simplicialb} is \texttt{true} for that node. It follows immediately from \Cref{lem:sbsound} that $\simplicial{u}{G}$.
\end{proof}

\Cref{lem:sbsound} and \Cref{lem:inv-elim-1} are rather important, as they prove that the nodes inside of a \gls{peo} are simplicial with respect to the graph where they are extracted. This property is at the base of our coloring algorithm. In fact, we know that coloring a simplicial node simply consists in finding a color that is not already taken by its neighbors.

\section{Second Invariant of \texttt{eliminate\_step}}

Let us define the notation for an empty graph.

\begin{definition}[Emtpy Graph]
    Let $G = (V, E)$ we say that $G$ is the empty graph, that is $G = G_\emptyset$, iff $V = \emptyset$ and $E = \emptyset$.
\end{definition}

We introduce an inductive definition of chordality with the $\chordalindsymbol$ relation.

\begin{definition}[$\chordalindsymbol$]\label{def:chordal2}
Let $G = (V, E)$, we say that graph $G$ is chordal, that is $\chordalind{G}$, if one of the following rules are satisfied:
\begin{mathpar}
    \inferrule*[Right=ChordalEmpty]
        {\empty}
        {\chordalind{G_\emptyset}}
    \\
    \inferrule*[Right=ChordalStep]
        {\exists u (\simplicial{u}{G} \ \land \chordalind{G - u})}
        {\chordalind{G}}
\end{mathpar}
\end{definition}

From now on, we will refer to chordality as \Cref{def:chordal1} with $\chordalpeosymbol$, to distinguish it from the $\chordalindsymbol$ predicate we just introduced. Intuitively, these two definitions should be equivalent. In order to prove it, we start with the forward implication.

\begin{lemma}[Correctness of $\chordalindsymbol$]\label{lem:chordal12}
    Let $G = (V, E)$, if it is the case that $\chordalpeo{G}$ then $\chordalind{G}$.
\end{lemma}

\begin{proof}
    Because of $\chordalpeo{G}$, there exists a permutation $u_1, u_2, \dots, u_n$ which is a \gls{peo}. We proceed by induction over the length of the \gls{peo}.

    \medskip

    \textbf{Base case:}
    If the \gls{peo} is empty, this means that $G$ is the empty graph. Follows by \textsc{ChordalEmpty} that $\chordalind{G}$ holds.

    \medskip

    \textbf{Inductive hypothesis:}
    Assume that if $u_1, u_2, \dots, u_n$ is a \gls{peo}, then $\chordalind{G}$.

    \medskip

    \textbf{Inductive step:}
    We add the simplicial node $u_{n+1}$ into the \gls{peo}, obtaining $G'$. We must prove that, if the sequence $u_1, u_2, \dots u_n, u_{n+1}$ is a \gls{peo}, then $\chordalind{G'}$ holds.
    Recall \Cref{def:peo}, therefore if $\chordalpeo{G'}$ then $\chordalpeo{G' - u_{n+1}}$. We use the inductive hypothesis to obtain that $\chordalind{G}$. Now, once again, we add $u_{n+1}$ back into graph $G$. In our assumption, we expanded the \gls{peo} with $u_{n+1}$, because $u_{n+1}$ is inside a \gls{peo}, it must be the case that $\simplicial{u_{n+1}}{G'}$. Moreover, we know that $\chordalind{G}$, which is the same as saying that $\chordalind{G' - u_{n+1}}$. The two propositions $\simplicial{u_{n+1}}{G'}$ and $\chordalind{G' - u_{n+1}}$, form exactly the premise of \textsc{ChordalStep}. Because of that, $\chordalind{G'}$ holds.
\end{proof}

Now, we prove the backwards implication.

\begin{lemma}[Soundness of $\chordalindsymbol$]\label{lem:chordal21}
    Let $G = (V, E)$, if it is the case that $\chordalind{G}$ then $\chordalpeo{G}$.
\end{lemma}
\begin{proof}
    We proceed by induction, this time, over the size of the graph.

    \textbf{Base case:}
    If $G$ is empty, there exists a \gls{peo}, which simply is an empty sequence.

    \medskip

    \textbf{Inductive hypothesis:}
    Assume that, if for all the graphs $G = (V, E)$ such that $|V| < n$, if $\chordalind{G}$, then there exists a \gls{peo} for $G$.

    \medskip

    \textbf{Inductive step:}
    We need to prove that for all the graphs $G' = (V', E')$ such that $|V'| < n+1$, if $\chordalind{G'}$, then there exists a \gls{peo} for $G'$.
    Because $\chordalind{G'}$, there exists a node $v$ such that $\simplicial{v}{G'}$ and $\chordalind{G' - v}$. Since $|V(G' - v)| < n$, we apply the inductive hypothesis, obtaining that $u_1, u_2, \dots, u_n$ is a valid \gls{peo} for $G' - v$. Then, because $\simplicial{v}{G'}$, we create a \gls{peo} for $G'$ which is $u_1, u_2, \dots, u_n, v$.
\end{proof}

Now, we prove the completeness of \texttt{is\_simplicialb} with respect to $\simplicialsymbol$.

\begin{lemma}[Completeness of \texttt{is\_simplicialb}]\label{lem:sbcomp}
Let $G = (V, E)$ and $u \in V$ such that $\simplicial{u}{G}$ holds, then \texttt{is\_simplicialb} returns \texttt{true}. \Coqed
\end{lemma}

\begin{lemma}[Second Invariant of \texttt{eliminate\_step}]\label{lem:inv-elim-2}
    Let $G = (V, E)$, if it is the case that $\chordalpeo{G}$, and \texttt{eliminate\_step} does not return any node, then $G = G_\emptyset$. \Coqed
\end{lemma}
\begin{proof}
    Assume that $\chordalpeo{G}$ and that \texttt{eliminate\_next} does not return any node. By \Cref{lem:chordal12}, $\chordalind{G}$ holds. As stated in \Cref{def:chordal2}, either $G = G_\emptyset$, or there exists $u$ such that $\simplicial{u}{G}$ and $\chordalind{G - u}$. In the second case, \Cref{lem:sbcomp} lets us derive that \texttt{is\_simplicialb} returns \texttt{true} for some $u$. However, if that was the case, \texttt{eliminate\_step} would have returned node $u$, which is not the case. Because of that, the only possible case is the first one, where $G = G_\emptyset$.
\end{proof}

\section{Partial correctness of \texttt{eliminate}}

After defining the two invariants for the \texttt{eliminate\_step} function, we prove the partial correctness of \texttt{eliminate}.

\begin{theorem}[Partial Correctness of \texttt{eliminate}]\label{thm:par-cor}
    Let $G = (V, E)$ such that $\chordalpeo{G}$, if \texttt{eliminate\_step} returns node $u$, then $\simplicial{u}{G}$, otherwise $G = G_\emptyset$. \Coqed
\end{theorem}

An additional result from graph theory is the following:

\begin{theorem}[Chordality Invariant After Node Removal]\label{thm:cho-inv}
    Given graph $G = (V, E)$, if $\chordalind{G}$, then $\chordalind{G - u}$ for an arbitrary $u$~\cite{golumbic2004algorithmic}.
\end{theorem}

We do not include a proof for \Cref{thm:cho-inv}. However, this proposition is rather important as it entails that, if an initial chordal graph is given, the \texttt{eliminate} function will ultimately return a \gls{peo} that contains every node of the graph.